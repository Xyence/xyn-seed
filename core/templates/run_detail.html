{% extends "base.html" %}

{% block title %}Run {{ run.name }} - Xyn Seed Core{% endblock %}

{% block content %}
<div class="page-header">
    <h2>{{ run.name }}</h2>
    <p class="meta"><a href="/ui/runs">‚Üê Back to Runs</a></p>
</div>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
        <div>
            <h3>Run Overview</h3>
            {% if run.status.value == 'completed' %}
            <span class="badge badge-success">{{ run.status.value }}</span>
            {% elif run.status.value == 'failed' %}
            <span class="badge badge-danger">{{ run.status.value }}</span>
            {% elif run.status.value == 'running' %}
            <span class="badge badge-info">{{ run.status.value }}</span>
            {% elif run.status.value == 'cancelled' %}
            <span class="badge badge-warning">{{ run.status.value }}</span>
            {% else %}
            <span class="badge badge-secondary">{{ run.status.value }}</span>
            {% endif %}
        </div>
        <div class="meta">
            <div>Run ID: <code>{{ run.id }}</code></div>
            <div>Correlation ID: <code>{{ run.correlation_id }}</code></div>
        </div>
    </div>

    <table>
        <tr>
            <th style="width: 150px;">Created At</th>
            <td>{{ run.created_at.strftime('%Y-%m-%d %H:%M:%S UTC') }}</td>
        </tr>
        <tr>
            <th>Started At</th>
            <td>{{ run.started_at.strftime('%Y-%m-%d %H:%M:%S UTC') if run.started_at else '-' }}</td>
        </tr>
        <tr>
            <th>Completed At</th>
            <td>{{ run.completed_at.strftime('%Y-%m-%d %H:%M:%S UTC') if run.completed_at else '-' }}</td>
        </tr>
        <tr>
            <th>Actor</th>
            <td>{{ run.actor }}</td>
        </tr>
    </table>

    {% if run.inputs %}
    <h4 style="margin-top: 1.5rem;">Inputs</h4>
    <pre>{{ run.inputs | tojson(indent=2) }}</pre>
    {% endif %}

    {% if run.outputs %}
    <h4 style="margin-top: 1.5rem;">Outputs</h4>
    <pre>{{ run.outputs | tojson(indent=2) }}</pre>
    {% endif %}

    {% if run.error %}
    <h4 style="margin-top: 1.5rem;">Error</h4>
    <pre style="background: #f8d7da; color: #721c24;">{{ run.error | tojson(indent=2) }}</pre>
    {% endif %}
</div>

<div class="card">
    <h3>Steps ({{ steps | length }})</h3>
    {% if steps %}
    <table style="margin-top: 1rem;">
        <thead>
            <tr>
                <th>#</th>
                <th>Name</th>
                <th>Kind</th>
                <th>Status</th>
                <th>Duration</th>
            </tr>
        </thead>
        <tbody>
            {% for step in steps %}
            <tr>
                <td>{{ step.idx }}</td>
                <td><strong>{{ step.name }}</strong></td>
                <td><code>{{ step.kind }}</code></td>
                <td>
                    {% if step.status.value == 'completed' %}
                    <span class="badge badge-success">{{ step.status.value }}</span>
                    {% elif step.status.value == 'failed' %}
                    <span class="badge badge-danger">{{ step.status.value }}</span>
                    {% elif step.status.value == 'running' %}
                    <span class="badge badge-info">{{ step.status.value }}</span>
                    {% elif step.status.value == 'skipped' %}
                    <span class="badge badge-warning">{{ step.status.value }}</span>
                    {% else %}
                    <span class="badge badge-secondary">{{ step.status.value }}</span>
                    {% endif %}
                </td>
                <td class="meta">
                    {% if step.completed_at and step.started_at %}
                    {{ ((step.completed_at - step.started_at).total_seconds()) | round(3) }}s
                    {% else %}
                    -
                    {% endif %}
                </td>
            </tr>
            {% if step.outputs %}
            <tr style="background: #f8f9fa;">
                <td colspan="5">
                    <strong>Outputs:</strong>
                    <pre style="margin-top: 0.5rem;">{{ step.outputs | tojson(indent=2) }}</pre>
                </td>
            </tr>
            {% endif %}
            {% if step.error %}
            <tr style="background: #f8d7da;">
                <td colspan="5">
                    <strong>Error:</strong>
                    <pre style="margin-top: 0.5rem; background: transparent;">{{ step.error | tojson(indent=2) }}</pre>
                </td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="meta">No steps yet</p>
    {% endif %}
</div>

<div class="card">
    <h3>Events ({{ events | length }})</h3>
    {% if events %}
    <table style="margin-top: 1rem;">
        <thead>
            <tr>
                <th>Occurred At</th>
                <th>Event Name</th>
                <th>Actor</th>
            </tr>
        </thead>
        <tbody>
            {% for event in events %}
            <tr>
                <td class="meta">{{ event.occurred_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                <td><code>{{ event.event_name }}</code></td>
                <td>{{ event.actor }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="meta">No events</p>
    {% endif %}
</div>

{% if artifacts %}
<div class="card">
    <h3>Artifacts ({{ artifacts | length }})</h3>
    <table style="margin-top: 1rem;">
        <thead>
            <tr>
                <th>Name</th>
                <th>Kind</th>
                <th>Size</th>
                <th>Created At</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for artifact in artifacts %}
            <tr>
                <td><strong>{{ artifact.name }}</strong></td>
                <td><code>{{ artifact.kind }}</code></td>
                <td class="meta">{{ (artifact.byte_length / 1024) | round(2) if artifact.byte_length else 0 }} KB</td>
                <td class="meta">{{ artifact.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                <td>
                    <a href="/api/v1/artifacts/{{ artifact.id }}/download" class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">Download</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}
{% endblock %}
